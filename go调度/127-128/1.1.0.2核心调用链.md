
### 📘 GORM 核心语法系统记忆指南

#### 1. 标准操作公式

在 Go 中，一个标准的数据库操作代码块通常长这样：

Go

```
// 1. 接收者   2. 方法名   3. 必须传 ctx   4. 业务参数
func (r *Repository) DoSomething(ctx context.Context, data *model.Data) error {
    // 5. 链式调用：实例 -> 绑定上下文 -> 过滤条件 -> 核心动作 -> 获取错误
    return r.db.WithContext(ctx).Where("id = ?", data.ID).Updates(data).Error
}
```

---

#### 2. 必须记忆的“核心动作” (Finisher Methods)

这些方法会真正触发 SQL 的生成和执行。

|**动作**|**对应 SQL**|**关键记忆点**|
|---|---|---|
|**`.Create(&data)`**|`INSERT`|**回填属性**：执行后，数据库生成的 ID 和创建时间会自动写回 `data` 结构体中。|
|**`.First(&data)`**|`SELECT … LIMIT 1`|**单条查询**：如果没查到，会返回特定的 `gorm.ErrRecordNotFound` 错误。|
|**`.Find(&slice)`**|`SELECT *`|**批量查询**：将多条结果填充到切片（Slice/List）中。|
|**`.Updates(&data)`**|`UPDATE`|**局部更新**：默认只更新非零值的字段。|
|**`.Save(&data)`**|`INSERT/UPDATE`|**全量保存**：主键为空则插入，有值则全字段覆盖更新。|
|**`.Delete(&data)`**|`DELETE`|**物理/软删**：根据主键删除；如果模型包含 `DeletedAt` 字段，则执行软删除。|

---

#### 3. 必须记忆的“链式配置” (Chainable Methods)

这些方法用于构建 SQL 的细节（类似于 MP 的 `QueryWrapper`）。

- **`.WithContext(ctx)`**：**最重要的规范**。用于超时控制和链路追踪。如果用户取消请求，数据库操作会立即停止，避免资源浪费。
    
- **`.Where(query, args…)`**：过滤条件，如 `.Where("name = ?", "jack")`。
    
- **`.Limit(n)` / `.Offset(n)`**：分页必备。
    
- **`.Order("column DESC")`**：排序。
    
- **`.Table("name")`**：手动指定表名（通常 GORM 会自动识别模型对应的表名）。
    

---

#### 4. 三个“底层直觉” (非常重要)

在写代码时，脑子里要时刻紧绷这根弦：

- **指针意识 (`&`)**：
    
    - 只要是涉及**把数据库里的东西拿出来**（查询）或者**让数据库把生成的东西塞回来**（插入回填），参数必须传地址（指针 `&`）。
        
    - **原因**：传值是副本，函数运行完副本就丢了，你的原始变量拿不到任何更新。
        
- **错误处理 (`.Error`)**：
    
    - GORM 不会 `throw Exception`。
        
    - 所有的成功或失败，最后都要通过 `.Error` 来获取。如果 `err != nil`，说明操作失败了。
        
- **资源节约 (`Context`)**：
    
    - 养成习惯，第一步永远是 `.WithContext(ctx)`。
        

---

### 📝 巩固练习

如果你现在要写一个方法：**“根据用户 ID (`userID`)，查询该用户下所有的短链接列表”**。

你会怎么组合这些“积木”？

Go

```
func (r *shortLinkRepository) ListByUserID(ctx context.Context, userID uint32) ([]*model.ShortLink, error) {
    var links []*model.ShortLink
    
    // 请在此处脑补或写出你的链式调用代码
    err := r.db.WithContext(ctx).Where("user_id = ?", userID).Find(&links).Error
    
    return links, err
}
```

**需要我为你演示一下如何处理常见的“数据未找到”错误（First 方法找不到数据时）吗？**