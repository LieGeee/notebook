# 员工短链功能实现笔记

## 一、功能概述

**目标**：为员工生成可自定义有效期的短链接，方便分享员工资料页

**服务位置**：auth-service（系统基础服务）

**开发顺序**：Migration → Model → Repository → Service → Handler → 前端API → 前端组件

  

---

  

## 二、开发步骤（按顺序执行）

  

### Step 1: 数据库迁移

文件：`backend/services/auth-service/migrations/010_create_short_links.up.sql`

```sql

CREATE TABLE IF NOT EXISTS sys_shortlinks (

    id BIGINT PRIMARY KEY AUTO_INCREMENT,

    tenant_id BIGINT NOT NULL COMMENT '租户ID',

    user_id BIGINT NOT NULL COMMENT '用户ID',

    code VARCHAR(16) NOT NULL COMMENT '短链码',

    target_url VARCHAR(512) NOT NULL COMMENT '目标URL',

    expire_at DATETIME NOT NULL COMMENT '过期时间',

    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,

    UNIQUE KEY uk_code (code),

    KEY idx_user_id (user_id),

    KEY idx_tenant_expire (tenant_id, expire_at)

) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='短链接表';

```

回滚文件：`010_create_short_links.down.sql`

```sql

DROP TABLE IF EXISTS sys_shortlinks;

```

执行迁移后再继续下一步。

  

### Step 2: Model（数据模型）

文件：`backend/services/auth-service/internal/repository/model/short_link.go`

```go

package model

  

import "time"

  

type ShortLink struct {

    ID        int64     `gorm:"primaryKey;autoIncrement"`

    TenantID  int64     `gorm:"index;not null;comment:租户ID"`

    UserID    int64     `gorm:"index;not null;comment:用户ID"`

    Code      string    `gorm:"uniqueIndex;size:16;not null;comment:短链码"`

    TargetURL string    `gorm:"size:512;not null;comment:目标URL"`

    ExpireAt  time.Time `gorm:"index;not null;comment:过期时间"`

    CreatedAt time.Time `gorm:"autoCreateTime"`

}

  

func (ShortLink) TableName() string {

    return "sys_shortlinks"

}

```

  

### Step 3: Repository（数据层）

文件：`backend/services/auth-service/internal/repository/short_link_repository.go`

```go

package repository

  

import (

    "context"

    "go-xl/services/auth-service/internal/repository/model"

    "gorm.io/gorm"

)

  

type ShortLinkRepository interface {

    Create(ctx context.Context, link *model.ShortLink) error

    FindByCode(ctx context.Context, code string) (*model.ShortLink, error)

    FindByUserID(ctx context.Context, userID int64, page, limit int) ([]*model.ShortLink, int64, error)

    Delete(ctx context.Context, code string) error

}

  

type shortLinkRepository struct {

    db *gorm.DB

}

  

func NewShortLinkRepository(db *gorm.DB) ShortLinkRepository {

    return &shortLinkRepository{db: db}

}

  

func (r *shortLinkRepository) Create(ctx context.Context, link *model.ShortLink) error {

    return r.db.WithContext(ctx).Create(link).Error

}

  

func (r *shortLinkRepository) FindByCode(ctx context.Context, code string) (*model.ShortLink, error) {

    var link model.ShortLink

    err := r.db.WithContext(ctx).Where("code = ?", code).First(&link).Error

    return &link, err

}

  

func (r *shortLinkRepository) FindByUserID(ctx context.Context, userID int64, page, limit int) ([]*model.ShortLink, int64, error) {

    var links []*model.ShortLink

    var total int64

    query := r.db.WithContext(ctx).Model(&model.ShortLink{}).Where("user_id = ?", userID)

    query.Count(&total)

    offset := (page - 1) * limit

    err := query.Order("created_at DESC").Offset(offset).Limit(limit).Find(&links).Error

    return links, total, err

}

  

func (r *shortLinkRepository) Delete(ctx context.Context, code string) error {

    return r.db.WithContext(ctx).Where("code = ?", code).Delete(&model.ShortLink{}).Error

}

```
[[1.1.0.1解释函数中的含义]]
[[1.1.0repository]]
[[1.1.1直接命名create]]
### Step 4: Service（业务层）

文件：`backend/services/auth-service/internal/service/short_link_service.go`
[[]]

```go

package service

  

import (

    "context"

    "crypto/rand"

    "encoding/base64"

    "fmt"

    "time"

    "go-xl/services/auth-service/internal/repository"

    "go-xl/services/auth-service/internal/repository/model"

)

  

type ShortLinkService interface {

    Generate(ctx context.Context, tenantID, userID int64, expireHours int) (*ShortLinkResponse, error)

    GetByCode(ctx context.Context, code string) (*model.ShortLink, error)

    ListByUser(ctx context.Context, userID int64, page, limit int) (*ShortLinkListResponse, error)

    Delete(ctx context.Context, code string) error

}

  

type ShortLinkResponse struct {

    Code     string    `json:"code"`

    ShortURL string    `json:"short_url"`

    ExpireAt time.Time `json:"expire_at"`

}

  

type ShortLinkListResponse struct {

    List  []*model.ShortLink `json:"list"`

    Total int64              `json:"total"`

}

  

type shortLinkService struct {

    repo    repository.ShortLinkRepository

    baseURL string

}

  

func NewShortLinkService(repo repository.ShortLinkRepository, baseURL string) ShortLinkService {

    return &shortLinkService{repo: repo, baseURL: baseURL}

}

  

func (s *shortLinkService) Generate(ctx context.Context, tenantID, userID int64, expireHours int) (*ShortLinkResponse, error) {

    code, err := generateCode(8)

    if err != nil {

        return nil, fmt.Errorf("生成短码失败: %w", err)

    }

    expireAt := time.Now().Add(time.Duration(expireHours) * time.Hour)

    targetURL := fmt.Sprintf("%s/personnel/profile/%d", s.baseURL, userID)

    link := &model.ShortLink{

        TenantID:  tenantID,

        UserID:    userID,

        Code:      code,

        TargetURL: targetURL,

        ExpireAt:  expireAt,

    }

    if err := s.repo.Create(ctx, link); err != nil {

        return nil, fmt.Errorf("保存短链失败: %w", err)

    }

    return &ShortLinkResponse{

        Code:     code,

        ShortURL: fmt.Sprintf("%s/s/%s", s.baseURL, code),

        ExpireAt: expireAt,

    }, nil

}

  

func (s *shortLinkService) GetByCode(ctx context.Context, code string) (*model.ShortLink, error) {

    return s.repo.FindByCode(ctx, code)

}

  

func (s *shortLinkService) ListByUser(ctx context.Context, userID int64, page, limit int) (*ShortLinkListResponse, error) {

    list, total, err := s.repo.FindByUserID(ctx, userID, page, limit)

    if err != nil {

        return nil, err

    }

    for _, item := range list {

        item.TargetURL = fmt.Sprintf("%s/s/%s", s.baseURL, item.Code)

    }

    return &ShortLinkListResponse{List: list, Total: total}, nil

}

  

func (s *shortLinkService) Delete(ctx context.Context, code string) error {

    return s.repo.Delete(ctx, code)

}

  

func generateCode(length int) (string, error) {

    bytes := make([]byte, length)

    if _, err := rand.Read(bytes); err != nil {

        return "", err

    }

    return base64.URLEncoding.EncodeToString(bytes)[:length], nil

}

```
[[1.2.0 service结构体为什么定义这里]]
[[1.2.1Generate函数解读]]
  

### Step 5: Handler（接口层）

文件：`backend/services/auth-service/internal/handler/short_link_handler.go`

```go

package handler

  

import (

    "context"

    "go-xl/services/auth-service/internal/service"

    pb "go-xl/shared/proto/auth"

)

  

type ShortLinkHandler struct {

    pb.UnimplementedShortLinkServiceServer

    svc service.ShortLinkService

}

  

func NewShortLinkHandler(svc service.ShortLinkService) *ShortLinkHandler {

    return &ShortLinkHandler{svc: svc}

}

  

func (h *ShortLinkHandler) Generate(ctx context.Context, req *pb.GenerateShortLinkRequest) (*pb.GenerateShortLinkResponse, error) {

    tenantID, _ := getTenantIDFromContext(ctx)

    result, err := h.svc.Generate(ctx, tenantID, req.UserId, int(req.ExpireHours))

    if err != nil {

        return &pb.GenerateShortLinkResponse{Code: 500000, Message: err.Error()}, nil

    }

    return &pb.GenerateShortLinkResponse{

        Code: 200000, Message: "success",

        Data: &pb.ShortLinkData{

            Code: result.Code, ShortUrl: result.ShortURL,

            ExpireAt: result.ExpireAt.Format("2006-01-02 15:04:05"),

        },

    }, nil

}

  

func (h *ShortLinkHandler) List(ctx context.Context, req *pb.ListShortLinkRequest) (*pb.ListShortLinkResponse, error) {

    result, err := h.svc.ListByUser(ctx, req.UserId, int(req.Page), int(req.Limit))

    if err != nil {

        return &pb.ListShortLinkResponse{Code: 500000, Message: err.Error()}, nil

    }

    var list []*pb.ShortLinkItem

    for _, item := range result.List {

        list = append(list, &pb.ShortLinkItem{

            Code: item.Code, ShortUrl: item.TargetURL,

            ExpireAt: item.ExpireAt.Format("2006-01-02 15:04:05"),

        })

    }

    return &pb.ListShortLinkResponse{

        Code: 200000, Message: "success",

        Data: &pb.ShortLinkListData{List: list, Total: result.Total},

    }, nil

}

  

func (h *ShortLinkHandler) Delete(ctx context.Context, req *pb.DeleteShortLinkRequest) (*pb.DeleteShortLinkResponse, error) {

    if err := h.svc.Delete(ctx, req.Code); err != nil {

        return &pb.DeleteShortLinkResponse{Code: 500000, Message: err.Error()}, nil

    }

    return &pb.DeleteShortLinkResponse{Code: 200000, Message: "删除成功"}, nil

}

```

  

### Step 6: 注册依赖（重要！别忘）

在 `cmd/main.go` 或 `wire.go` 中注册：

```go

// 初始化 Repository

shortLinkRepo := repository.NewShortLinkRepository(db)

// 初始化 Service

shortLinkSvc := service.NewShortLinkService(shortLinkRepo, cfg.BaseURL)

// 初始化 Handler

shortLinkHandler := handler.NewShortLinkHandler(shortLinkSvc)

// 注册到 gRPC Server

pb.RegisterShortLinkServiceServer(grpcServer, shortLinkHandler)

```

  

### Step 7: 前端 API

文件：`frontend/src/api/shortlink.js`

```javascript

import api from './request.js'

  

export const shortlinkAPI = {

  generateShortLink: async (data) => {

    try {

      const response = await api.post('/v1/shortlinks', data)

      return response.data

    } catch (error) {

      throw error.response?.data || error

    }

  },

  getShortLinks: async (params = {}) => {

    try {

      const response = await api.get('/v1/shortlinks', { params })

      return response.data

    } catch (error) {

      throw error.response?.data || error

    }

  },

  deleteShortLink: async (code) => {

    try {

      const response = await api.delete(`/v1/shortlinks/${code}`)

      return response.data

    } catch (error) {

      throw error.response?.data || error

    }

  }

}

export default shortlinkAPI

```

  

### Step 8: 前端组件

文件：`frontend/src/components/business/ShortLinkGenerator.vue`

```vue

<template>

  <div class="shortlink-generator">

    <div class="section-header">

      <el-icon :size="20" color="#6366f1"><Link /></el-icon>

      <h2 class="section-title">员工短链生成</h2>

    </div>

    <div class="generator-content">

      <div class="config-area">

        <el-form :model="form" label-width="100px" size="default">

          <el-form-item label="有效期">

            <el-select v-model="form.expireHours" placeholder="选择有效期">

              <el-option label="1小时" :value="1" />

              <el-option label="6小时" :value="6" />

              <el-option label="24小时" :value="24" />

              <el-option label="7天" :value="168" />

              <el-option label="30天" :value="720" />

              <el-option label="自定义" :value="-1" />

            </el-select>

          </el-form-item>

          <el-form-item v-if="form.expireHours === -1" label="自定义时长">

            <el-input-number v-model="form.customHours" :min="1" :max="8760" />

            <span class="unit-text">小时</span>

          </el-form-item>

          <el-form-item>

            <el-button type="primary" :loading="loading" @click="handleGenerate">

              <el-icon><Plus /></el-icon>生成短链

            </el-button>

          </el-form-item>

        </el-form>

      </div>

      <div v-if="shortLinkResult" class="result-area">

        <div class="result-card">

          <div class="result-label">短链地址</div>

          <div class="result-link">

            <span class="link-text">{{ shortLinkResult.short_url }}</span>

            <el-button type="primary" link @click="handleCopy">

              <el-icon><CopyDocument /></el-icon>复制

            </el-button>

          </div>

          <div class="result-meta">有效期至：{{ formatExpireTime(shortLinkResult.expire_at) }}</div>

        </div>

      </div>

      <div class="history-area">

        <div class="history-header">

          <span>历史记录</span>

          <el-button type="primary" link size="small" @click="loadHistory">刷新</el-button>

        </div>

        <el-table :data="historyList" size="small" v-loading="historyLoading">

          <el-table-column prop="short_url" label="短链" min-width="200">

            <template #default="{ row }">

              <el-link type="primary" :href="row.short_url" target="_blank">{{ row.short_url }}</el-link>

            </template>

          </el-table-column>

          <el-table-column prop="expire_at" label="过期时间" width="180">

            <template #default="{ row }">{{ formatExpireTime(row.expire_at) }}</template>

          </el-table-column>

          <el-table-column label="状态" width="80">

            <template #default="{ row }">

              <el-tag :type="isExpired(row.expire_at) ? 'danger' : 'success'" size="small">

                {{ isExpired(row.expire_at) ? '已过期' : '有效' }}

              </el-tag>

            </template>

          </el-table-column>

          <el-table-column label="操作" width="80">

            <template #default="{ row }">

              <el-button type="danger" link size="small" @click="handleDelete(row.code)">删除</el-button>

            </template>

          </el-table-column>

        </el-table>

      </div>

    </div>

  </div>

</template>

  

<script setup>

import { ref, reactive, onMounted, computed } from 'vue'

import { ElMessage, ElMessageBox } from 'element-plus'

import { Link, Plus, CopyDocument } from '@element-plus/icons-vue'

import { shortlinkAPI } from '@/api/shortlink'

import { useUserStore } from '@/stores'

  

const userStore = useUserStore()

const form = reactive({ expireHours: 24, customHours: 48 })

const loading = ref(false)

const historyLoading = ref(false)

const shortLinkResult = ref(null)

const historyList = ref([])

  

const actualExpireHours = computed(() => form.expireHours === -1 ? form.customHours : form.expireHours)

  

const handleGenerate = async () => {

  loading.value = true

  try {

    const res = await shortlinkAPI.generateShortLink({

      user_id: userStore.userInfo?.id,

      expire_hours: actualExpireHours.value

    })

    if (res.code === 200000) {

      shortLinkResult.value = res.data

      ElMessage.success('短链生成成功')

      loadHistory()

    } else {

      ElMessage.error(res.message || '生成失败')

    }

  } catch (error) {

    console.error('生成短链失败:', error)

    ElMessage.error('生成短链失败')

  } finally {

    loading.value = false

  }

}

  

const handleCopy = async () => {

  try {

    await navigator.clipboard.writeText(shortLinkResult.value.short_url)

    ElMessage.success('已复制到剪贴板')

  } catch (error) {

    ElMessage.error('复制失败')

  }

}

  

const loadHistory = async () => {

  historyLoading.value = true

  try {

    const res = await shortlinkAPI.getShortLinks({ user_id: userStore.userInfo?.id, page: 1, limit: 10 })

    if (res.code === 200000) historyList.value = res.data?.list || []

  } catch (error) {

    console.error('加载历史失败:', error)

  } finally {

    historyLoading.value = false

  }

}

  

const handleDelete = async (code) => {

  try {

    await ElMessageBox.confirm('确定删除这个短链吗？', '提示', { type: 'warning' })

    const res = await shortlinkAPI.deleteShortLink(code)

    if (res.code === 200000) { ElMessage.success('删除成功'); loadHistory() }

  } catch (error) {

    if (error !== 'cancel') ElMessage.error('删除失败')

  }

}

  

const formatExpireTime = (time) => time ? new Date(time).toLocaleString('zh-CN') : '-'

const isExpired = (time) => new Date(time) < new Date()

onMounted(() => loadHistory())

</script>

  

<style scoped>

.shortlink-generator { background: white; border-radius: 16px; padding: 1.5rem; box-shadow: 0 4px 24px rgba(0,0,0,0.06); margin-bottom: 1.5rem; }

.section-header { display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1.25rem; }

.section-title { font-size: 1.125rem; font-weight: 600; color: #1f2937; margin: 0; }

.config-area { margin-bottom: 1.5rem; }

.unit-text { margin-left: 8px; color: #6b7280; }

.result-area { margin-bottom: 1.5rem; }

.result-card { background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%); border: 1px solid #bbf7d0; border-radius: 12px; padding: 1rem 1.25rem; }

.result-label { font-size: 0.875rem; color: #16a34a; margin-bottom: 0.5rem; }

.result-link { display: flex; align-items: center; gap: 1rem; }

.link-text { font-size: 1rem; font-weight: 600; color: #166534; word-break: break-all; }

.result-meta { margin-top: 0.5rem; font-size: 0.8rem; color: #6b7280; }

.history-area { border-top: 1px solid #e5e7eb; padding-top: 1rem; }

.history-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem; font-weight: 500; color: #374151; }

</style>

```

  

### Step 9: Dashboard 引入组件

文件：`frontend/src/views/Dashboard.vue`

```vue

<!-- template 中添加 -->

<ShortLinkGenerator />

  

<!-- script 中添加 -->

import ShortLinkGenerator from '../components/business/ShortLinkGenerator.vue'

```

  

---

  

## 三、开发检查清单

- [ ] Step 1: 执行数据库迁移

- [ ] Step 2: 创建 Model 文件

- [ ] Step 3: 创建 Repository 文件

- [ ] Step 4: 创建 Service 文件

- [ ] Step 5: 创建 Handler 文件

- [ ] Step 6: 在 main.go/wire.go 注册依赖

- [ ] Step 7: 创建前端 API 文件

- [ ] Step 8: 创建前端组件

- [ ] Step 9: 在 Dashboard 引入组件

- [ ] 启动服务测试